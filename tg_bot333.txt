from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import (
    Application, CommandHandler, MessageHandler,
    filters, ContextTypes, ConversationHandler
)

BOT_TOKEN = "7554228349:AAEiGdw0dveHdGrFk3IHf92wDOwRa8PgXUo"
ADMIN_ID = 5374390102  # SÉ™nin Telegram ID-n

(YIL, MARKA, MODEL, YAZI, RENK) = range(5)
order_counter = 0

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸš— ZÉ™hmÉ™t olmasa avtomobilin *istehsal ilini* daxil edin:", parse_mode="Markdown")
    return YIL

async def year(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['year'] = update.message.text
    await update.message.reply_text("ğŸš˜ Avtomobilin *markasÄ±nÄ±* yazÄ±n:")
    return MARKA

async def brand(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['brand'] = update.message.text
    await update.message.reply_text("ğŸ”§ Avtomobilin *modelini* yazÄ±n:")
    return MODEL

async def model(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['model'] = update.message.text
    await update.message.reply_text("âœï¸ Alt hissÉ™yÉ™ yazÄ±lacaq mÉ™tni yazÄ±n:")
    return YAZI

async def text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['text'] = update.message.text
    reply_markup = ReplyKeyboardMarkup(
        [["AÃ§Ä±q rÉ™ng", "Qara rÉ™ng"]],
        resize_keyboard=True, one_time_keyboard=True
    )
    await update.message.reply_text("ğŸ¨ RÉ™ngi seÃ§in:", reply_markup=reply_markup)
    return RENK

async def color(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global order_counter
    order_counter += 1
    order_code = f"CVA{order_counter:02d}"
    context.user_data['color'] = update.message.text

    user = update.effective_user
    full_name = f"{user.first_name or ''} {user.last_name or ''}".strip()
    telegram_id = user.id

    order_message = (
        f"ğŸ“¥ *Yeni sifariÅŸ gÉ™ldi!*\n\n"
        f"ğŸ‘¤ Ä°stifadÉ™Ã§i: {full_name}\n"
        f"ğŸ†” Telegram ID: `{telegram_id}`\n"
        f"ğŸ“¦ SifariÅŸ Kodu: `{order_code}`\n"
        f"ğŸš— Ä°l: {context.user_data['year']}\n"
        f"ğŸš™ Marka: {context.user_data['brand']}\n"
        f"ğŸ›  Model: {context.user_data['model']}\n"
        f"âœï¸ YazÄ±: {context.user_data['text']}\n"
        f"ğŸ¨ RÉ™ng: {context.user_data['color']}"
    )

    # AdminÉ™ gÃ¶ndÉ™r (yalnÄ±z admin gÃ¶rÉ™cÉ™k)
    await context.bot.send_message(chat_id=ADMIN_ID, text=order_message, parse_mode="Markdown")

    # MÃ¼ÅŸtÉ™riyÉ™ cavab
    whatsapp_link = f"https://wa.me/994554124042?text=SifariÅŸ%20kodum%20{order_code}%20-%20Ã–dÉ™niÅŸ%20Ã§eki%20É™lavÉ™%20edirÉ™m"
    await update.message.reply_text(
        f"âœ… SifariÅŸ qeydÉ™ alÄ±ndÄ±!\n\n"
        f"ğŸ“¦ SifariÅŸ kodu: `{order_code}`\n"
        f"ğŸ’³ ZÉ™hmÉ™t olmasa bu hesaba 15 AZN Ã¶dÉ™niÅŸ edin:\n"
        f"`4169 7388 1731 3939`\n\n"
        f"ğŸ“¤ Ã–dÉ™niÅŸ Ã§ekini vÉ™ sifariÅŸ kodunu gÃ¶ndÉ™rmÉ™k Ã¼Ã§Ã¼n:\n"
        f"[WhatsApp-a keÃ§id]({whatsapp_link})",
        parse_mode="Markdown",
        reply_markup=ReplyKeyboardRemove()
    )

    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("âŒ SifariÅŸ lÉ™ÄŸv edildi.", reply_markup=ReplyKeyboardRemove())
    return ConversationHandler.END

def main():
    app = Application.builder().token(BOT_TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            YIL: [MessageHandler(filters.TEXT & ~filters.COMMAND, year)],
            MARKA: [MessageHandler(filters.TEXT & ~filters.COMMAND, brand)],
            MODEL: [MessageHandler(filters.TEXT & ~filters.COMMAND, model)],
            YAZI: [MessageHandler(filters.TEXT & ~filters.COMMAND, text)],
            RENK: [MessageHandler(filters.TEXT & ~filters.COMMAND, color)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    app.add_handler(conv_handler)
    app.run_polling()

if __name__ == "__main__":
    main()
